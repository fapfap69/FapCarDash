<!DOCTYPE HTML>
<html>
  <head>
	<meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> 
	<meta name="viewport" content="width=device-width, initial-scale=1.0"> 
	<title>Fap cardash Maps page</title>
	<meta name="description" content="" />
	<meta name="keywords" content="" />
	<meta name="author" content="Fap" />
	<link rel="shortcut icon" href="../favicon.ico"> 
	<link rel="stylesheet" type="text/css" href="css/dashdefault.css" />
	<link rel="stylesheet" href="css/dashstyle.css" type="text/css">
	<script src="js/jquery-1.10.2.min.js" type="text/javascript"></script>
	<script src="js/jquery.zweatherfeed.min.js" type="text/javascript"></script>	
 	<script src="socket.io/socket.io.js"></script>

    <style type="text/css">
      #basicMap {
          width: 690px;
          height: 456px;
          position: absolute;
          left: 111px;
      }
    </style>

    <script src="js/OpenLayers.js"></script>
    <script src="js/OpenStreetMap.js"></</script>
    
    <script type="text/javascript">	
	/*  -------------------------------------------------------------------
		Extablish a connection with the server, obtains the list of
		parameters, 
	*/
	var SocketIo;

	function loadParams() {
		SocketIo = io.connect();
		SocketIo.on('connect', function() {
			SocketIo.emit('getparams','maps');   // after the socket connection make a parm request
			return;
			});

		SocketIo.on('listofobjects', function(data) {   // as soon the server replays read the params
			var obj = JSON.parse(data); 
			var i, type, name, value, pos;
						
			for(i=0;i<obj.paramArray.length;i++) {  // for each param ...
				var poi = new Object();
				poi.name = obj.paramArray[i].name;
				poi.lon = obj.paramArray[i].lon;
				poi.lat = obj.paramArray[i].lat;
				poi.type = obj.paramArray[i].type;
				poi.descr = obj.paramArray[i].descr;
				PointOfInterest.push(poi);
				}
			});			
				
		SocketIo.on('parameters', function(data) {   // as soon the server replays read the params
			var obj = JSON.parse(data); 
			var i, name, value, pos;
				
			for(i=0;i<obj.paramArray.length;i++) {  // for each param ...
				if(obj.paramArray[i].name == "isFixed") {
					actualPointerFix = obj.paramArray[i].value;
					}
				}
				// end of job...
				SocketIo.disconnect();
			});
		
		return;
	}
    </script>
    
    <script>
    	var map;
    	var actualLongitude = 36.0;
    	var actualLatitude = 49.0;
    	var actualZoom = 10;

    	var actualPointerFix = true;
    	var PointOfInterest = [];  // list of object POI
    	   	// ---
    	// ---------
    	
        var bounds = new OpenLayers.Bounds(-130, -48, 179, 67).transform(new OpenLayers.Projection("EPSG:4326"), new OpenLayers.Projection("EPSG:3857"));

        var map; //complex object of type OpenLayers.Map
    	var fromProjection = new OpenLayers.Projection("EPSG:4326");   // Transform from WGS 1984
		var toProjection   = new OpenLayers.Projection("EPSG:900913"); // to Spherical Mercator Projection
        
        OpenLayers.Util.onImageLoadError = function () {
            this.src = "http://4umaps.eu/img/no_image.png";
        }
    	
    	
    	function init() {

        	loadParams();  // load the parameters

		   	map = new OpenLayers.Map("basicMap" /*,  {
                controls: [
                    new OpenLayers.Control.Navigation(),
                    new OpenLayers.Control.PanZoomBar(),
                //           new OpenLayers.Control.Permalink(),
                    new OpenLayers.Control.ScaleLine({ geodesic: true })],
                //  new OpenLayers.Control.Permalink('permalink'),
                //  new OpenLayers.Control.MousePosition(),
                //  new OpenLayers.Control.Attribution()],
             //  maxExtent: bounds,
             //  restrictedExtent: bounds,
             //  maxResolution: 156543.0339,
                 units: 'm',
                 projection: toProjection,
                 displayProjection: fromProjection  
			}*/
		   	);
        	
        	map.addControl(new OpenLayers.Control.LayerSwitcher());
        	
        	actualLongitude = 13.41;
        	actualLatitude = 41.52;
        	
        	var position = new OpenLayers.LonLat(actualLongitude,actualLatitude).transform( fromProjection, toProjection);
        	actualZoom = 15; 
        	
        	
        	layerMapnik = new OpenLayers.Layer.OSM.Mapnik("Mapnik");
            layerMapnik.setOpacity(1);
            map.addLayer(layerMapnik); 
 
            layerCycleMap = new OpenLayers.Layer.OSM.CycleMap("CycleMap");
            layerCycleMap.setOpacity(1);
            map.addLayer(layerCycleMap);
			
            // setup the actual postion and the markers of POI
            positionsLayer = new OpenLayers.Layer.Vector("Positions");
            var positionVector = new OpenLayers.Geometry.Point(position.lon, position.lat);
        	var positionFeature = new OpenLayers.Feature.Vector(positionVector, {name:'actualPosition'}, {externalGraphic: 'images/markerActualPos.png', graphicHeight: 20, graphicWidth: 16});
        	positionsLayer.addFeatures(positionFeature);
        	
        	for(var i; i<PointOfInterest.length; i++) {
                var positionVector = new OpenLayers.Geometry.Point(PointOfInterest[i].lon, PointOfInterest[i].lat);
            	var poiFeature = new OpenLayers.Feature.Vector(positionVector, {name:PointOfInterest[i].name}, {externalGraphic: __getMarker(PointOfInterest[i].type), graphicHeight: 20, graphicWidth: 16});
        		positionsLayer.addFeatures(poiFeature);
        	}
        	map.addLayer(positionsLayer);
        	
        	// Add the click control
        	var click = new OpenLayers.Control.Click();
            map.addControl(click);
            click.activate();
        	
        	
          	map.setCenter(position, actualZoom );
      	}
      
        function __getMarker(type) {
        	switch(type) {
        	case "1":
        		return('images/markerPosType1.png');
        		break;
        	case "2":
        		return('images/markerPosType2.png');
        		break;
        	case "3":
        		return('images/markerPosType3.png');
        		break;
        	}
    		return('images/markerPosType1.png');
        }
               
        
      	function updatePosition(longitude, latitude) {
      		actualLongitude = longitude;
      		actualLatitude = latitude;
      		var theLayer = map.getLayersByName("Positions")[0];
      		var newPosition = new OpenLayers.LonLat(actualLongitude,actualLatitude).transform( fromProjection, toProjection);
	        var feature = theLayer.getFeaturesByAttribute('name', 'actualPosition')[0];
	        feature.move(newPosition);
	        if(actualPointerFix) map.setCenter(newPosition);
    	    return;
    	  
      	}
      	function newLatitude(lat){
      		updatePosition(actualLongitude, lat);
      		return;
      	}
      	function newLongitude(lon) {
      		updatePosition(lon, actualLatitude);
      		return;
      	}
      	
     	function swithcMapLayer(type) {
     		var thelayer;
     		switch(type) {
     		case 1:
     			thelayer = "Mapnik"; 
     			break;
     		case 2:
     			thelayer = "CycleMap";
     			break;
     		}
    		var thenewbase = map.getLayersByName(thelayer)[0];
     		map.setBaseLayer(thenewbase);
     		map.baseLayer.setVisibility(true);
     		return;
      	}
   
     	// control for the POI management
     	OpenLayers.Control.Click = OpenLayers.Class(OpenLayers.Control, {                
			defaultHandlerOptions: {
            	'single': true,
                'double': false,
                'pixelTolerance': 0,
                'stopSingle': false,
                'stopDouble': false
            	},

            initialize: function(options) {
                this.handlerOptions = OpenLayers.Util.extend(
                	{}, this.defaultHandlerOptions
                	);
                OpenLayers.Control.prototype.initialize.apply(
                    this, arguments
                    ); 
                this.handler = new OpenLayers.Handler.Click(
                    this, {
                    	'click': this.trigger
                        }, this.handlerOptions
                    );
                }, 

			trigger: function(e) {
            	var lonlat = map.getLonLatFromPixel(e.xy);
                alert("You clicked near " + lonlat.lat + " N, " + lonlat.lon + " E");
                }
            });
     	
     	
    </script>
  </head>
  <body onload="init();">
 	<aside id="menuHome" class="menuMain">
		<button id="but1" class="menuButton" onclick="location.href='fapcardashHome.html'">Home</button>
		<button id="fun1" class="menuButton" onclick="swithcMapLayer(1)">Street</button>
		<button id="fun2" class="menuButton" onclick="swithcMapLayer(2)">Topogr.</button>
		<button id="fun3" class="menuButton" ></button>
		<button id="fun4" class="menuButton" ></button>
		<button id="but2" class="menuButton" ></button>
	</aside>
 
    <div id="basicMap"></div>
  </body>
</html>
